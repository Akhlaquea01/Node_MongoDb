<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Stream Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .video-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        video {
            width: 100%;
            height: 500px;
            object-fit: contain;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .control-group h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .btn.danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1rem;
        }

        .status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #28a745;
        }

        .status.error {
            border-left-color: #dc3545;
        }

        .status.success {
            border-left-color: #28a745;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.info { color: #007bff; }
        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.warning { color: #ffc107; }

        .instructions {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .instructions h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .instructions code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Video Stream Test</h1>
            <p>Test your video streaming API with authentication</p>
        </div>

        <div class="content">
            <!-- Status -->
            <div class="status" id="statusCard">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <div id="statusDot" style="width: 12px; height: 12px; border-radius: 50%; background: #dc3545;"></div>
                    <span id="statusText" style="font-weight: bold; font-size: 1.2rem;">Ready to test</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <div style="font-size: 0.9rem; color: #6c757d;">Video ID</div>
                        <div id="videoId" style="font-size: 1.2rem; font-weight: bold;">Not set</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6c757d;">Stream Status</div>
                        <div id="streamStatus" style="font-size: 1.2rem; font-weight: bold;">Ready</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6c757d;">Last Update</div>
                        <div id="lastUpdate" style="font-size: 1.2rem; font-weight: bold;">-</div>
                    </div>
                </div>
            </div>

            <!-- Video Player -->
            <div class="video-container">
                <video id="videoPlayer" controls width="100%" height="500">
                    <source src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="control-group">
                    <h3>üé¨ Video Settings</h3>
                    <div class="input-group">
                        <label for="videoIdInput">Video ID:</label>
                        <input type="text" id="videoIdInput" placeholder="Enter video ID (e.g., 68eb70dbf273795b7a999e22)" value="68eb70dbf273795b7a999e22">
                    </div>
                    <button class="btn success" onclick="loadVideo()">
                        üìπ Load Video
                    </button>
                    <button class="btn" onclick="testStreamAPI()">
                        üîç Test API
                    </button>
                </div>

                <div class="control-group">
                    <h3>üéÆ Player Controls</h3>
                    <button class="btn" onclick="playVideo()">
                        ‚ñ∂Ô∏è Play
                    </button>
                    <button class="btn" onclick="pauseVideo()">
                        ‚è∏Ô∏è Pause
                    </button>
                    <button class="btn" onclick="muteVideo()">
                        üîá Mute
                    </button>
                    <button class="btn" onclick="unmuteVideo()">
                        üîä Unmute
                    </button>
                </div>

                <div class="control-group">
                    <h3>üîß Debug Tools</h3>
                    <button class="btn" onclick="checkAuth()">
                        üîê Check Auth
                    </button>
                    <button class="btn" onclick="testCurl()">
                        üìã Test cURL
                    </button>
                    <button class="btn" onclick="clearLog()">
                        üóëÔ∏è Clear Log
                    </button>
                </div>
            </div>

            <!-- Instructions -->
            <div class="instructions">
                <h3>üìã How to Test Video Streaming</h3>
                <ol>
                    <li><strong>Enter Video ID:</strong> Use the video ID from your database (e.g., <code>68eb70dbf273795b7a999e22</code>)</li>
                    <li><strong>Load Video:</strong> Click "Load Video" to start streaming</li>
                    <li><strong>Test API:</strong> Use "Test API" to verify the endpoint works</li>
                    <li><strong>Check Auth:</strong> Verify your authentication tokens are working</li>
                </ol>
                <p><strong>API Endpoint:</strong> <code>GET /api/v1/videos/stream/:videoId</code></p>
                <p><strong>Authentication:</strong> Uses cookies (accessToken, refreshToken)</p>
            </div>

            <!-- Activity Log -->
            <div class="log" id="activityLog">
                <div class="log-entry info">[INFO] Video stream test page loaded</div>
                <div class="log-entry info">[INFO] Ready to test video streaming API</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:5000/api/v1";
        const ACCESS_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2NzllMzA4YmQzMTFlYTE5NzU4Mzc4NTEiLCJlbWFpbCI6ImFzaGZhcXVlMzg2QGdtYWlsLmNvbSIsInVzZXJuYW1lIjoiYXNoZmFxdWUzODYiLCJmdWxsTmFtZSI6IkFzaGZhcXVlIEFobWFkIiwiaWF0IjoxNzYwMjYwMTYxLCJleHAiOjE3NjAzNDY1NjF9.WAOpRXoS-wzGFBU22_8YeluVeI8TQH2UKZkuPOtoWEQ";
        const REFRESH_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2NzllMzA4YmQzMTFlYTE5NzU4Mzc4NTEiLCJpYXQiOjE3NjAyNjAxNjEsImV4cCI6MTc2MTEyNDE2MX0.bVurT_mUAeEQ8vo1CFQr-bPrvnkU5y-n48TN-PDEFkM";

        let currentVideoId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set cookies for authentication
            document.cookie = `accessToken=${ACCESS_TOKEN}; path=/`;
            document.cookie = `refreshToken=${REFRESH_TOKEN}; path=/`;
            
            log('System: Video stream test page initialized', 'success');
            log('System: Authentication cookies set', 'info');
        });

        // Load video
        async function loadVideo() {
            const videoId = document.getElementById('videoIdInput').value.trim();
            
            if (!videoId) {
                log('Please enter a video ID', 'warning');
                return;
            }

            currentVideoId = videoId;
            document.getElementById('videoId').textContent = videoId;
            
            try {
                const streamUrl = `${API_BASE}/videos/stream/${videoId}`;
                const videoPlayer = document.getElementById('videoPlayer');
                
                log(`Loading video: ${videoId}`, 'info');
                log(`Stream URL: ${streamUrl}`, 'info');
                
                // Set video source
                videoPlayer.src = streamUrl;
                
                // Add event listeners
                videoPlayer.onloadstart = () => log('Video: Loading started', 'info');
                videoPlayer.oncanplay = () => log('Video: Can start playing', 'success');
                videoPlayer.onplay = () => log('Video: Started playing', 'success');
                videoPlayer.onpause = () => log('Video: Paused', 'warning');
                videoPlayer.onerror = (e) => log('Video: Error - ' + e.message, 'error');
                
                updateStatus('Loading video...', '#ffc107');
                
            } catch (error) {
                log('Error loading video: ' + error.message, 'error');
                updateStatus('Error loading video', '#dc3545');
            }
        }

        // Test API endpoint
        async function testStreamAPI() {
            const videoId = document.getElementById('videoIdInput').value.trim();
            
            if (!videoId) {
                log('Please enter a video ID first', 'warning');
                return;
            }

            try {
                log(`Testing API endpoint: /api/v1/videos/stream/${videoId}`, 'info');
                
                const response = await fetch(`${API_BASE}/videos/stream/${videoId}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'video/mp4, video/*, */*'
                    }
                });

                log(`Response status: ${response.status} ${response.statusText}`, 'info');
                log(`Response headers: ${JSON.stringify([...response.headers.entries()])}`, 'info');

                if (response.ok) {
                    log('‚úÖ API endpoint is working correctly', 'success');
                    updateStatus('API working', '#28a745');
                } else {
                    log(`‚ùå API error: ${response.status} ${response.statusText}`, 'error');
                    updateStatus('API error', '#dc3545');
                }

            } catch (error) {
                log('‚ùå API test failed: ' + error.message, 'error');
                updateStatus('API test failed', '#dc3545');
            }
        }

        // Check authentication
        async function checkAuth() {
            try {
                log('Checking authentication...', 'info');
                
                // Test with a simple API call
                const response = await fetch(`${API_BASE}/videos`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    log('‚úÖ Authentication is working', 'success');
                    updateStatus('Auth working', '#28a745');
                } else {
                    log(`‚ùå Authentication failed: ${response.status}`, 'error');
                    updateStatus('Auth failed', '#dc3545');
                }

            } catch (error) {
                log('‚ùå Auth check failed: ' + error.message, 'error');
                updateStatus('Auth check failed', '#dc3545');
            }
        }

        // Test cURL command
        function testCurl() {
            const videoId = document.getElementById('videoIdInput').value.trim() || 'VIDEO_ID';
            const curlCommand = `curl --location 'http://localhost:5000/api/v1/videos/stream/${videoId}' \\
--header 'Cookie: accessToken=${ACCESS_TOKEN}; refreshToken=${REFRESH_TOKEN}'`;
            
            log('cURL command for testing:', 'info');
            log(curlCommand, 'info');
            
            // Copy to clipboard if possible
            if (navigator.clipboard) {
                navigator.clipboard.writeText(curlCommand).then(() => {
                    log('cURL command copied to clipboard', 'success');
                });
            }
        }

        // Player controls
        function playVideo() {
            const video = document.getElementById('videoPlayer');
            video.play();
            log('Player: Play command sent', 'info');
        }

        function pauseVideo() {
            const video = document.getElementById('videoPlayer');
            video.pause();
            log('Player: Pause command sent', 'info');
        }

        function muteVideo() {
            const video = document.getElementById('videoPlayer');
            video.muted = true;
            log('Player: Muted', 'info');
        }

        function unmuteVideo() {
            const video = document.getElementById('videoPlayer');
            video.muted = false;
            log('Player: Unmuted', 'info');
        }

        // Update status display
        function updateStatus(message, color) {
            document.getElementById('statusText').textContent = message;
            document.getElementById('statusDot').style.background = color;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Clear log
        function clearLog() {
            document.getElementById('activityLog').innerHTML = '';
            log('Log cleared', 'info');
        }

        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }
    </script>
</body>
</html>
