<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Live Stream</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .video-box {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .video-box h3 {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            margin: 0;
            text-align: center;
        }

        video {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .control-group h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn.danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .btn.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #28a745;
        }

        .status.offline {
            border-left-color: #dc3545;
        }

        .status.live {
            border-left-color: #ff6b6b;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.info { color: #007bff; }
        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.warning { color: #ffc107; }

        .instructions {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .instructions h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .instructions code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìπ Camera Live Stream</h1>
            <p>Stream your camera directly to the server with real-time monitoring</p>
        </div>

        <div class="content">
            <!-- Status -->
            <div class="status" id="statusCard">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <div id="statusDot" style="width: 12px; height: 12px; border-radius: 50%; background: #dc3545;"></div>
                    <span id="statusText" style="font-weight: bold; font-size: 1.2rem;">Checking status...</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div>
                        <div style="font-size: 0.9rem; color: #6c757d;">Camera Status</div>
                        <div id="cameraStatus" style="font-size: 1.2rem; font-weight: bold;">Not Started</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6c757d;">Stream Status</div>
                        <div id="streamStatus" style="font-size: 1.2rem; font-weight: bold;">Offline</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6c757d;">Last Update</div>
                        <div id="lastUpdate" style="font-size: 1.2rem; font-weight: bold;">-</div>
                    </div>
                </div>
            </div>

            <!-- Video Containers -->
            <div class="video-container">
                <div class="video-box">
                    <h3>üìπ Your Camera</h3>
                    <video id="localVideo" autoplay muted playsinline></video>
                </div>
                <div class="video-box">
                    <h3>üì∫ Live Stream</h3>
                    <video id="remoteVideo" controls autoplay muted playsinline></video>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="control-group">
                    <h3>üé• Camera Controls</h3>
                    <button class="btn" id="startCameraBtn" onclick="startCamera()">
                        üìπ Start Camera
                    </button>
                    <button class="btn" onclick="startCameraDefault()">
                        üìπ Start Default Camera
                    </button>
                    <button class="btn danger" id="stopCameraBtn" onclick="stopCamera()" disabled>
                        üõë Stop Camera
                    </button>
                </div>

                <div class="control-group">
                    <h3>üì° Stream Controls</h3>
                    <button class="btn success" id="startStreamBtn" onclick="startStreaming()" disabled>
                        üöÄ Start Streaming
                    </button>
                    <button class="btn danger" id="stopStreamBtn" onclick="stopStreaming()" disabled>
                        üõë Stop Streaming
                    </button>
                </div>

                <div class="control-group">
                    <h3>‚öôÔ∏è Settings</h3>
                    <select id="cameraSelect" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                        <option value="">Select Camera</option>
                    </select>
                    <button class="btn" onclick="loadCameras()" style="width: 100%; margin-bottom: 10px;">
                        üîÑ Refresh Cameras
                    </button>
                    <select id="qualitySelect" style="width: 100%; padding: 8px;">
                        <option value="720p">720p (HD)</option>
                        <option value="480p">480p (SD)</option>
                        <option value="360p">360p (Low)</option>
                    </select>
                </div>
            </div>

            <!-- Instructions -->
            <div class="instructions">
                <h3>üìã How to Use Camera Streaming</h3>
                <ol>
                    <li><strong>Start Camera:</strong> Click "Start Camera" to access your webcam</li>
                    <li><strong>Select Camera:</strong> Choose your preferred camera from the dropdown</li>
                    <li><strong>Start Streaming:</strong> Click "Start Streaming" to begin live broadcast</li>
                    <li><strong>View Stream:</strong> The right video shows your live stream</li>
                    <li><strong>Share Stream:</strong> Others can view your stream at the provided URL</li>
                </ol>
            </div>

            <!-- Activity Log -->
            <div class="log" id="activityLog">
                <div class="log-entry info">[INFO] Camera streaming page loaded</div>
                <div class="log-entry info">[INFO] Initializing camera access...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:5000/api/v1";
        const ACCESS_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2NzllMzA4YmQzMTFlYTE5NzU4Mzc4NTEiLCJlbWFpbCI6ImFzaGZhcXVlMzg2QGdtYWlsLmNvbSIsInVzZXJuYW1lIjoiYXNoZmFxdWUzODYiLCJmdWxsTmFtZSI6IkFzaGZhcXVlIEFobWFkIiwiaWF0IjoxNzYwMjYwMTYxLCJleHAiOjE3NjAzNDY1NjF9.WAOpRXoS-wzGFBU22_8YeluVeI8TQH2UKZkuPOtoWEQ";
        const REFRESH_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2NzllMzA4YmQzMTFlYTE5NzU4Mzc4NTEiLCJpYXQiOjE3NjAyNjAxNjEsImV4cCI6MTc2MTEyNDE2MX0.bVurT_mUAeEQ8vo1CFQr-bPrvnkU5y-n48TN-PDEFkM";

        let localStream = null;
        let isCameraActive = false;
        let isStreaming = false;
        let statusCheckInterval;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCameras();
            startStatusCheck();
            log('System: Camera streaming page initialized', 'success');
        });

        // Load available cameras
        async function loadCameras() {
            try {
                // First request camera permission to get device labels
                try {
                    await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    log('Camera permission granted', 'success');
                } catch (permError) {
                    log('Camera permission denied or not available', 'warning');
                }

                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                const cameraSelect = document.getElementById('cameraSelect');
                cameraSelect.innerHTML = '<option value="">Select Camera</option>';
                
                if (videoDevices.length === 0) {
                    const option = document.createElement('option');
                    option.value = 'default';
                    option.textContent = 'Default Camera';
                    cameraSelect.appendChild(option);
                    log('No specific cameras found, using default', 'warning');
                } else {
                    videoDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.textContent = device.label || `Camera ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });
                }
                
                log(`Found ${videoDevices.length} camera(s)`, 'info');
                
                // Auto-select first camera if only one available
                if (videoDevices.length === 1) {
                    cameraSelect.value = videoDevices[0].deviceId;
                    log('Auto-selected single camera', 'info');
                }
                
            } catch (error) {
                log('Error loading cameras: ' + error.message, 'error');
            }
        }

        // Start camera
        async function startCamera() {
            try {
                const cameraId = document.getElementById('cameraSelect').value;
                const quality = document.getElementById('qualitySelect').value;
                
                log(`Attempting to start camera: ${cameraId || 'default'}`, 'info');
                
                let constraints;
                
                if (cameraId && cameraId !== 'default') {
                    // Use specific camera
                    constraints = {
                        video: {
                            deviceId: { exact: cameraId },
                            width: { ideal: getQualityDimensions(quality).width },
                            height: { ideal: getQualityDimensions(quality).height },
                            frameRate: { ideal: 30 }
                        },
                        audio: true
                    };
                } else {
                    // Use default camera with fallback
                    constraints = {
                        video: {
                            width: { ideal: getQualityDimensions(quality).width },
                            height: { ideal: getQualityDimensions(quality).height },
                            frameRate: { ideal: 30 }
                        },
                        audio: true
                    };
                }

                log('Requesting camera access...', 'info');
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('localVideo').srcObject = localStream;
                
                isCameraActive = true;
                updateUI();
                log('Camera started successfully', 'success');
                
                // Update camera selection if it was default
                if (!cameraId || cameraId === 'default') {
                    const videoTrack = localStream.getVideoTracks()[0];
                    if (videoTrack) {
                        const settings = videoTrack.getSettings();
                        log(`Using camera: ${settings.deviceId || 'default'}`, 'info');
                    }
                }
                
            } catch (error) {
                log('Error starting camera: ' + error.message, 'error');
                
                // Try fallback with basic constraints
                if (error.name === 'NotAllowedError') {
                    log('Camera permission denied. Please allow camera access and try again.', 'error');
                } else if (error.name === 'NotFoundError') {
                    log('No camera found. Please check your camera connection.', 'error');
                } else {
                    log('Trying fallback camera access...', 'warning');
                    try {
                        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                        document.getElementById('localVideo').srcObject = localStream;
                        isCameraActive = true;
                        updateUI();
                        log('Camera started with fallback settings', 'success');
                    } catch (fallbackError) {
                        log('Fallback camera access failed: ' + fallbackError.message, 'error');
                    }
                }
            }
        }

        // Start camera with default settings (no selection required)
        async function startCameraDefault() {
            try {
                log('Starting camera with default settings...', 'info');
                
                const quality = document.getElementById('qualitySelect').value;
                const constraints = {
                    video: {
                        width: { ideal: getQualityDimensions(quality).width },
                        height: { ideal: getQualityDimensions(quality).height },
                        frameRate: { ideal: 30 }
                    },
                    audio: true
                };

                log('Requesting camera access with default settings...', 'info');
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('localVideo').srcObject = localStream;
                
                isCameraActive = true;
                updateUI();
                log('Default camera started successfully', 'success');
                
                // Update the camera select dropdown with the actual device
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    const settings = videoTrack.getSettings();
                    log(`Using camera: ${settings.deviceId || 'default'}`, 'info');
                    
                    // Update the dropdown to show the selected camera
                    const cameraSelect = document.getElementById('cameraSelect');
                    cameraSelect.value = settings.deviceId || 'default';
                }
                
            } catch (error) {
                log('Error starting default camera: ' + error.message, 'error');
                
                if (error.name === 'NotAllowedError') {
                    log('Camera permission denied. Please allow camera access and try again.', 'error');
                } else if (error.name === 'NotFoundError') {
                    log('No camera found. Please check your camera connection.', 'error');
                }
            }
        }

        // Stop camera
        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            document.getElementById('localVideo').srcObject = null;
            isCameraActive = false;
            isStreaming = false;
            updateUI();
            log('Camera stopped', 'info');
        }

        // Start streaming
        async function startStreaming() {
            try {
                if (!isCameraActive) {
                    log('Please start camera first', 'warning');
                    return;
                }

                // For now, we'll simulate streaming by showing the local video in the remote video
                // In a real implementation, you would send the stream to your server
                document.getElementById('remoteVideo').srcObject = localStream;
                isStreaming = true;
                updateUI();
                log('Streaming started successfully', 'success');
                
            } catch (error) {
                log('Error starting stream: ' + error.message, 'error');
            }
        }

        // Stop streaming
        function stopStreaming() {
            document.getElementById('remoteVideo').srcObject = null;
            isStreaming = false;
            updateUI();
            log('Streaming stopped', 'info');
        }

        // Get quality dimensions
        function getQualityDimensions(quality) {
            const dimensions = {
                '720p': { width: 1280, height: 720 },
                '480p': { width: 854, height: 480 },
                '360p': { width: 640, height: 360 }
            };
            return dimensions[quality] || dimensions['720p'];
        }

        // Update UI based on current state
        function updateUI() {
            const startCameraBtn = document.getElementById('startCameraBtn');
            const stopCameraBtn = document.getElementById('stopCameraBtn');
            const startStreamBtn = document.getElementById('startStreamBtn');
            const stopStreamBtn = document.getElementById('stopStreamBtn');
            const statusCard = document.getElementById('statusCard');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const cameraStatus = document.getElementById('cameraStatus');
            const streamStatus = document.getElementById('streamStatus');

            // Update button states
            startCameraBtn.disabled = isCameraActive;
            stopCameraBtn.disabled = !isCameraActive;
            startStreamBtn.disabled = !isCameraActive || isStreaming;
            stopStreamBtn.disabled = !isStreaming;

            // Update status display
            if (isStreaming) {
                statusCard.className = 'status live';
                statusDot.style.background = '#ff6b6b';
                statusText.textContent = 'üî¥ LIVE STREAMING';
                cameraStatus.textContent = 'Active';
                streamStatus.textContent = 'Live';
            } else if (isCameraActive) {
                statusCard.className = 'status';
                statusDot.style.background = '#28a745';
                statusText.textContent = 'üìπ Camera Active';
                cameraStatus.textContent = 'Active';
                streamStatus.textContent = 'Ready';
            } else {
                statusCard.className = 'status offline';
                statusDot.style.background = '#dc3545';
                statusText.textContent = '‚è∏Ô∏è Camera Offline';
                cameraStatus.textContent = 'Inactive';
                streamStatus.textContent = 'Offline';
            }

            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Status checking
        function startStatusCheck() {
            updateUI();
            statusCheckInterval = setInterval(updateUI, 3000);
        }

        function stopStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        }

        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopCamera();
            stopStatusCheck();
        });
    </script>
</body>
</html>
